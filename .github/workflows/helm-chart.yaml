# .github/workflows/helm-chart.yml
# -----------------------------------------------------
# GitHub Actions â†’ Package & Push Helm Chart to AWS ECR (OIDC)
# -----------------------------------------------------

name: Helm Chart CI/CD

on:
  push:
    branches:
      - main
      - master

env:
  AWS_REGION: ap-south-1
  HELM_VERSION: 3.14.0
  HELM_CHART_NAME: order-microservice

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read
jobs:
  # -----------------------------------------------------
  # Lint Helm Chart
  # -----------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Run helm lint
        run: |
          echo "Running helm lint..."
          helm lint .

  # -----------------------------------------------------
  # Build Helm Chart
  # -----------------------------------------------------
  build-helm:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Show chart structure (debug)
        run: |
          echo "========== Chart Directory Structure =========="
          ls -lRh
          echo ""
          echo "========== Chart.yaml =========="
          cat Chart.yaml
          echo ""
          echo "========== Templates Directory =========="
          ls -lh templates/

      - name: Package Helm chart
        run: |
          echo "Packaging Helm chart..."
          CHART_VERSION="0.1.${{ github.run_number }}"
          APP_VERSION="${{ github.sha }}"
          APP_VERSION="${APP_VERSION:0:7}"
          
          helm package . --version ${CHART_VERSION} --app-version ${APP_VERSION}
          ls -lh *.tgz

      - name: Verify packaged chart contents
        run: |
          echo "========== Contents of Packaged Chart =========="
          tar -tzf *.tgz
          echo ""
          echo "========== Detailed file sizes =========="
          tar -tzvf *.tgz

      - name: Upload Helm chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: "*.tgz"
          retention-days: 1

  # -----------------------------------------------------
  # Push Helm Chart to AWS ECR (via OIDC)
  # -----------------------------------------------------
  push-helm:
    runs-on: ubuntu-latest
    needs: build-helm
    steps:
      - name: Download Helm chart artifact
        uses: actions/download-artifact@v4
        with:
          name: helm-chart

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Get chart info
        id: chart-info
        run: |
          CHART_PACKAGE=$(ls *.tgz)
          CHART_NAME=$(echo $CHART_PACKAGE | sed 's/-.*//')
          CHART_VERSION=$(echo $CHART_PACKAGE | sed 's/.*-//' | sed 's/.tgz//')
          echo "package=${CHART_PACKAGE}" >> $GITHUB_OUTPUT
          echo "name=${CHART_NAME}" >> $GITHUB_OUTPUT
          echo "version=${CHART_VERSION}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Create ECR repository if it doesn't exist
        run: |
          REPO_NAME="helm/${{ steps.chart-info.outputs.name }}"
          
          if ! aws ecr describe-repositories --repository-names ${REPO_NAME} --region ${{ secrets.AWS_REGION }} 2>/dev/null; then
            echo "Repository ${REPO_NAME} does not exist. Creating..."
            aws ecr create-repository \
              --repository-name ${REPO_NAME} \
              --region ${{ secrets.AWS_REGION }}
            echo "Repository created successfully"
          else
            echo "Repository ${REPO_NAME} already exists"
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Push Helm chart to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          CHART_PACKAGE: ${{ steps.chart-info.outputs.package }}
        run: |
          echo "Pushing Helm chart to ECR..."
          ls -lh *.tgz
          echo "Chart package: ${CHART_PACKAGE}"
          
          # Push to ECR
          helm push ${CHART_PACKAGE} oci://${ECR_REGISTRY}/helm
          
          echo "âœ… Chart pushed successfully!"

      - name: Output chart details
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          CHART_NAME: ${{ steps.chart-info.outputs.name }}
          CHART_VERSION: ${{ steps.chart-info.outputs.version }}
        run: |
          echo "=========================================="
          echo "âœ… Helm Chart Published Successfully!"
          echo "=========================================="
          echo "Registry: ${ECR_REGISTRY}"
          echo "Chart: ${CHART_NAME}"
          echo "Version: ${CHART_VERSION}"
          echo ""
          echo "ðŸ“¦ Pull command:"
          echo "  helm pull oci://${ECR_REGISTRY}/helm/${CHART_NAME} --version ${CHART_VERSION}"
          echo ""
          echo "ðŸš€ Install command:"
          echo "  helm install my-release oci://${ECR_REGISTRY}/helm/${CHART_NAME} --version ${CHART_VERSION}"
          echo "=========================================="